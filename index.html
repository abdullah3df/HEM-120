<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة قص مقاطع HE — ملف واحد</title>
  <!-- Tailwind عبر CDN لتنسيق سريع -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* خطوط بسيطة (اختياري) */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    html,body{font-family:Cairo,system-ui,ui-sans-serif;}
    /* منع تحديد النص فوق الرسم أثناء السحب */
    svg,svg *{user-select:none}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- رأس الصفحة -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-bold">حاسبة قص HE (HEA / HEB / HEM)</h1>
      <div class="text-xs opacity-70">Δ = b<sub>eff</sub> · tan(θ)</div>
    </div>
  </header>

  <!-- المحتوى -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- لوحة الإعدادات -->
    <section class="lg:col-span-1 bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold text-lg mb-3">الإعدادات</h2>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <label class="col-span-2">سلسلة المقطع (Series)</label>
        <select id="series" class="col-span-2 rounded-lg border px-3 py-2">
          <option value="HEA">HEA</option>
          <option value="HEB" selected>HEB</option>
          <option value="HEM">HEM</option>
        </select>

        <label class="col-span-2">المقاس (Size)</label>
        <select id="size" class="col-span-2 rounded-lg border px-3 py-2"></select>

        <label class="col-span-2">زاوية التجميع θ (°)</label>
        <input id="angle" type="number" min="1" max="45" step="0.5" value="22"
               class="col-span-2 rounded-lg border px-3 py-2" />

        <label class="col-span-2">خلوص قرب العمود (mm) — يُطرح مرة واحدة</label>
        <input id="clearance" type="number" min="0" step="1" value="0"
               class="col-span-2 rounded-lg border px-3 py-2" />

        <label class="col-span-2">مقياس الرسم على الشاشة (px لكل mm)</label>
        <input id="scale" type="number" min="0.4" step="0.1" value="1.2"
               class="col-span-2 rounded-lg border px-3 py-2" />

        <div class="col-span-2 flex items-center gap-2 mt-2">
          <input id="showAssembly" type="checkbox" checked class="w-4 h-4">
          <label for="showAssembly">إظهار تجميع قطعتين (Two-piece assembly)</label>
        </div>
      </div>

      <div class="mt-4 rounded-xl bg-slate-100 p-3 text-sm" id="readout">
        <!-- يُملأ ديناميكياً -->
      </div>

      <div class="mt-4 flex gap-2">
        <button id="btnReset" class="px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300">
          افتراضي
        </button>
        <button id="btnScreenshot" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
          حفظ الرسم كصورة (PNG)
        </button>
      </div>
      <p class="text-xs text-slate-500 mt-2">* قبل التنفيذ على الماكينة تأكد من اعتماد b<sub>eff</sub> المناسب وفق خلوص الكتف/الفيلية.</p>
    </section>

    <!-- قطعة واحدة -->
    <section class="lg:col-span-2 bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold text-lg mb-3">رؤية قطعة واحدة — Top View</h2>
      <div class="overflow-auto border rounded-xl p-3">
        <div id="singleWrapper"></div>
      </div>
    </section>

    <!-- تجميع قطعتين -->
    <section id="assemblySection" class="lg:col-span-3 bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold text-lg mb-3">تجميع قطعتين — Top View</h2>
      <div class="overflow-auto border rounded-xl p-3">
        <div id="assemblyWrapper"></div>
      </div>
      <p class="text-sm text-slate-600 mt-3">
        كل قطعة تُقص بنفس الزاوية θ. مع انعكاس اتجاه خطّي القص الأحمرين، يلتقي السطحان لتكوين زاوية التجميع المطلوبة.
      </p>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-6 text-xs text-slate-500">
    نسخة ملف واحد — انسخ واحفظ كـ <b>index.html</b> وشغّل مباشرة.
  </footer>

  <!-- البيانات والمنطق -->
  <script>
    // جدول عرض الجناح (b) بالمليمتر — مبسّط وقابل للتوسعة
    const HE_TABLE = {
      HEA: {100:100,120:120,140:140,160:160,180:180,200:200,220:220,240:240,260:260,280:280,300:300,320:320,340:340,360:360,400:300},
      HEB: {100:100,120:120,140:140,160:160,180:180,200:200,220:220,240:240,260:260,280:280,300:300,320:300,340:300,360:300,400:300},
      HEM: {100:120,120:120,140:140,160:160,180:180,200:200,220:220,240:240,260:260,280:280,300:300,320:300,340:300,360:300,400:300}
    };

    const $series = document.getElementById('series');
    const $size = document.getElementById('size');
    const $angle = document.getElementById('angle');
    const $clearance = document.getElementById('clearance');
    const $scale = document.getElementById('scale');
    const $readout = document.getElementById('readout');
    const $singleWrapper = document.getElementById('singleWrapper');
    const $assemblyWrapper = document.getElementById('assemblyWrapper');
    const $assemblySection = document.getElementById('assemblySection');
    const $showAssembly = document.getElementById('showAssembly');
    const $btnReset = document.getElementById('btnReset');
    const $btnScreenshot = document.getElementById('btnScreenshot');

    function populateSizes() {
      const s = $series.value;
      const sizes = Object.keys(HE_TABLE[s]).map(Number).sort((a,b)=>a-b);
      $size.innerHTML = sizes.map(v => `<option value="${v}" ${v===180?'selected':''}>${v}</option>`).join('');
    }

    function mm(val){ return Number(val)||0; }

    function calc() {
      const s = $series.value;
      const sz = Number($size.value);
      let angDeg = Number($angle.value);
      if (angDeg < 1) angDeg = 1;
      if (angDeg > 45) angDeg = 45;
      $angle.value = angDeg;

      const clearance = Math.max(0, mm($clearance.value));
      const scale = Math.max(0.1, Number($scale.value) || 1.2);

      const bNom = HE_TABLE[s][sz] ?? 180;     // عرض الجناح الاسمي
      const bEff = Math.max(1, bNom - clearance); // العرض الفعّال
      const theta = angDeg * Math.PI / 180;
      const delta = bEff * Math.tan(theta);    // الإزاحة الطولية لكل قطعة

      renderReadout({s, sz, bNom, bEff, angDeg, delta});
      renderSingle({bEff, delta, scale});
      renderAssembly({bEff, delta, scale, show: $showAssembly.checked, angDeg});
    }

    function renderReadout({s, sz, bNom, bEff, angDeg, delta}) {
      $readout.innerHTML = `
        <div>البروفايل: <b>${s} ${sz}</b></div>
        <div>عرض الجناح الاسمي b: <b>${bNom.toFixed(0)} mm</b></div>
        <div>العرض الفعّال b<sub>eff</sub>: <b>${bEff.toFixed(1)} mm</b></div>
        <div>زاوية θ: <b>${angDeg.toFixed(1)}°</b></div>
        <div>الإزاحة الطولية لكل قطعة Δ: <b>${delta.toFixed(1)} mm</b></div>
        <div class="opacity-70 mt-1">المعادلة: Δ = b<sub>eff</sub> · tan(θ)</div>
      `;
    }

    function renderSingle({bEff, delta, scale}) {
      const W = bEff * scale;                  // px عبر العرض (Y)
      const dPx = delta * scale;               // px الإزاحة
      const L  = Math.max(200, Math.min(600, Math.round((bEff + delta) * 1.4))) * scale; // طول إطار العرض

      const svg = `
        <svg id="svgSingle" width="${L + 40}" height="${W + 40}" viewBox="0 0 ${L + 40} ${W + 40}">
          <defs>
            <marker id="arrow" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto">
              <path d="M0,0 L8,4 L0,8 z" />
            </marker>
          </defs>

          <!-- إطار مستطيل يمثل شريحة من الجناح -->
          <rect x="10" y="10" width="${L}" height="${W}" rx="8" fill="#f8fafc" stroke="#e2e8f0" />

          <!-- خط القص المائل -->
          <line x1="${10}" y1="${10}" x2="${10 + dPx}" y2="${10 + W}" stroke="#ef4444" stroke-width="3" />

          <!-- b_eff -->
          <line x1="${10 - 4}" y1="${10}" x2="${10 - 4}" y2="${10 + W}" stroke="#334155" stroke-dasharray="6 4" marker-end="url(#arrow)" />
          <text x="0" y="${10 + W/2}" font-size="12" transform="rotate(-90, 0, ${10 + W/2})">
            b_eff = ${bEff.toFixed(1)} mm
          </text>

          <!-- Δ -->
          <line x1="${10}" y1="${10 + W + 8}" x2="${10 + dPx}" y2="${10 + W + 8}" stroke="#334155" marker-end="url(#arrow)" />
          <text x="${10 + dPx/2 - 20}" y="${10 + W + 24}" font-size="12">Δ ≈ ${ (delta).toFixed(1) } mm</text>

          <!-- محاور إرشادية -->
          <text x="${10 + L - 60}" y="${10 + W + 24}" font-size="12">طول القطعة (X)</text>
          <text x="${10 + L + 6}" y="${10 + 14}" font-size="12" transform="rotate(90, ${10 + L + 6}, ${10 + 14})">
            عرض الجناح (Y)
          </text>
        </svg>
      `;
      $singleWrapper.innerHTML = svg;
    }

    function renderAssembly({bEff, delta, scale, show, angDeg}) {
      if (!show) {
        $assemblySection.style.display = 'none';
        return;
      }
      $assemblySection.style.display = '';

      const W = bEff * scale;
      const dPx = delta * scale;
      const L  = Math.max(200, Math.min(600, Math.round((bEff + delta) * 1.4))) * scale;

      const svg = `
        <svg id="svgAssembly" width="${L + 60}" height="${W*2 + 80}" viewBox="0 0 ${L + 60} ${W*2 + 80}">
          <!-- القطعة العليا -->
          <rect x="20" y="20" width="${L}" height="${W}" rx="8" fill="#f8fafc" stroke="#e2e8f0" />
          <line x1="20" y1="20" x2="${20 + dPx}" y2="${20 + W}" stroke="#ef4444" stroke-width="3" />

          <!-- القطعة السفلى (معكوسة) -->
          <rect x="20" y="${40 + W}" width="${L}" height="${W}" rx="8" fill="#f8fafc" stroke="#e2e8f0" />
          <line x1="20" y1="${40 + W + W}" x2="${20 + dPx}" y2="${40 + W}" stroke="#ef4444" stroke-width="3" />

          <!-- نص الزاوية -->
          <text x="${20 + dPx + 8}" y="${40 + W}" font-size="14" font-weight="600" fill="#ef4444">
            θ ≈ ${angDeg.toFixed(1)}°
          </text>

          <!-- سهم Δ إرشادي -->
          <line x1="20" y1="${28 + W}" x2="${20 + dPx}" y2="${28 + W}" stroke="#334155" stroke-dasharray="6 4" />
          <text x="${20 + dPx/2 - 10}" y="${24 + W}" font-size="12">Δ</text>
        </svg>
      `;
      $assemblyWrapper.innerHTML = svg;
    }

    function toPng(svgId, filename='he-cut.png') {
      const svg = document.getElementById(svgId);
      if(!svg) return;
      const xml = new XMLSerializer().serializeToString(svg);
      const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0);
        const url = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      };
      img.src = svg64;
    }

    // أحداث
    [$series,$size,$angle,$clearance,$scale,$showAssembly].forEach(el => el.addEventListener('input', calc));
    $btnReset.addEventListener('click', () => {
      $series.value = 'HEB';
      populateSizes();
      $size.value = '180';
      $angle.value = 22;
      $clearance.value = 0;
      $scale.value = 1.2;
      $showAssembly.checked = true;
      calc();
    });
    $btnScreenshot.addEventListener('click', () => {
      // يحفظ تجميع القطعتين إن كان ظاهرًا، وإلا يحفظ قطعة واحدة
      const id = $showAssembly.checked ? 'svgAssembly' : 'svgSingle';
      const name = $showAssembly.checked ? 'assembly.png' : 'single.png';
      toPng(id, name);
    });

    // تهيئة أولية
    populateSizes();
    document.getElementById('size').value = '180';
    calc();
  </script>
</body>
</html>
